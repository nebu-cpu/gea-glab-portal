{% extends "base.html" %}

{% block title %}{{ project.reference_number }} - GEA Portal{% endblock %}
{% block page_header %}Project Details{% endblock %}

{% block content %}
<!-- Project Header -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h4 class="fw-bold mb-1">{{ project.reference_number }}</h4>
        <p class="text-muted mb-0">
            {{ project.client.name }} · {{ project.assessment_type.replace('_', ' ').title() }} Assessment
        </p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('project_chat', project_id=project.id) }}" class="btn btn-gea-outline">
            <i class="bi bi-chat-dots me-1"></i>Chat
        </a>
        <span class="badge bg-{{ 'success' if project.gea_status == 'approved' else 'warning' if project.gea_status == 'pending' else 'danger' }} fs-6 align-self-center">
            GEA: {{ project.gea_status.replace('_', ' ').title() }}
        </span>
    </div>
</div>

<!-- 8-Phase Workflow Progress -->
<div class="card mb-4">
    <div class="card-body">
        <h6 class="text-uppercase text-muted small fw-bold mb-3">Certification Workflow - Phase {{ project.current_phase }} of 8</h6>
        <div class="d-flex flex-wrap gap-2 mb-3">
            {% for phase_num in range(1, 9) %}
            <div class="phase-indicator text-center p-2 rounded flex-fill" style="min-width: 100px; 
                background: {% if phase_num < project.current_phase %}#d1fae5{% elif phase_num == project.current_phase %}#dbeafe{% else %}#f1f5f9{% endif %};
                border: 2px solid {% if phase_num < project.current_phase %}#10b981{% elif phase_num == project.current_phase %}#3b82f6{% else %}#e2e8f0{% endif %};">
                <div class="fw-bold" style="color: {% if phase_num < project.current_phase %}#065f46{% elif phase_num == project.current_phase %}#1e40af{% else %}#64748b{% endif %};">
                    {% if phase_num < project.current_phase %}
                    <i class="bi bi-check-circle-fill"></i>
                    {% else %}
                    {{ phase_num }}
                    {% endif %}
                </div>
                <small class="d-block" style="font-size: 0.7rem;">{{ phases[phase_num]['name'][:15] }}{% if phases[phase_num]['name']|length > 15 %}...{% endif %}</small>
            </div>
            {% endfor %}
        </div>
        
        <div class="alert alert-info mb-0">
            <strong>Current Phase:</strong> Phase {{ project.current_phase }} - {{ phases[project.current_phase]['name'] }}
        </div>
    </div>
</div>

<!-- Phase Tabs -->
<ul class="nav nav-tabs mb-4" id="phaseTabs">
    {% for phase_num in range(1, 9) %}
    <li class="nav-item">
        <a class="nav-link {% if phase_num == project.current_phase %}active{% endif %} {% if phase_num > project.current_phase %}text-muted{% endif %}" 
           href="#phase{{ phase_num }}" data-bs-toggle="tab">
            {% if phase_num < project.current_phase %}<i class="bi bi-check-circle-fill text-success me-1"></i>{% endif %}
            Phase {{ phase_num }}
        </a>
    </li>
    {% endfor %}
</ul>

<div class="tab-content">
    {% for phase_num in range(1, 9) %}
    <div class="tab-pane fade {% if phase_num == project.current_phase %}show active{% endif %}" id="phase{{ phase_num }}">
        <div class="row g-4">
            <!-- Left: Checklist & Documents -->
            <div class="col-lg-8">
                <!-- Phase Info -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>{{ phases[phase_num]['name'] }}</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0 text-muted">
                            {% if phase_num == 1 %}
                            Initial enrollment and eligibility screening. Organization submits application, GLAB evaluates readiness.
                            {% elif phase_num == 2 %}
                            Assessor assignment and ethical safeguards. Conflict of interest declarations and code of conduct.
                            {% elif phase_num == 3 %}
                            Optional preliminary assessment for readiness review before formal engagement.
                            {% elif phase_num == 4 %}
                            Formal engagement and planning. Letter of engagement, scope definition, and timeline.
                            {% elif phase_num == 5 %}
                            Formal assessment fieldwork. Evidence collection, triangulation, and non-conformance tracking.
                            {% elif phase_num == 6 %}
                            Report drafting and peer review. Quality assurance before certification decision.
                            {% elif phase_num == 7 %}
                            Certification decision by committee. Final review and outcome communication.
                            {% elif phase_num == 8 %}
                            Post-certification obligations. Change notifications and ongoing compliance.
                            {% endif %}
                        </p>
                    </div>
                </div>
                
                <!-- Phase Checklist -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-check2-square me-2"></i>Phase {{ phase_num }} Checklist</span>
                        {% set phase_checklist = checklist_by_phase.get(phase_num, []) %}
                        {% set completed_count = phase_checklist|selectattr('is_completed')|list|length %}
                        <span class="badge bg-{{ 'success' if completed_count == phase_checklist|length and phase_checklist|length > 0 else 'secondary' }}">
                            {{ completed_count }}/{{ phase_checklist|length }}
                        </span>
                    </div>
                    <div class="card-body">
                        {% for item in phase_checklist %}
                        <div class="checklist-item d-flex align-items-start gap-3 p-2 rounded mb-2 {% if item.is_completed %}bg-light{% endif %}" 
                             style="cursor: {% if phase_num == project.current_phase and (current_user.role in ['glab_admin', 'glab_assessor'] or current_user.is_gea()) %}pointer{% else %}default{% endif %};"
                             {% if phase_num == project.current_phase %}onclick="toggleChecklist({{ project.id }}, {{ item.id }}, this)"{% endif %}>
                            <input type="checkbox" class="form-check-input mt-1" {% if item.is_completed %}checked{% endif %} 
                                   {% if phase_num != project.current_phase %}disabled{% endif %}>
                            <div class="flex-grow-1">
                                <div class="{% if item.is_completed %}text-decoration-line-through text-muted{% endif %}">
                                    {{ item.item_text }}
                                </div>
                                {% if item.is_completed and item.completer %}
                                <small class="text-muted">
                                    <i class="bi bi-check me-1"></i>{{ item.completer.full_name or item.completer.username }} · {{ item.completed_at.strftime('%b %d, %Y') if item.completed_at else '' }}
                                </small>
                                {% endif %}
                            </div>
                            {% if item.is_required %}
                            <span class="badge bg-danger-subtle text-danger">Required</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-3 mb-0">No checklist items defined.</p>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Phase Documents -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-folder me-2"></i>Phase {{ phase_num }} Documents</span>
                        {% if phase_num == project.current_phase %}
                        <a href="{{ url_for('upload_document', project_id=project.id) }}?phase={{ phase_num }}" class="btn btn-sm btn-gea">
                            <i class="bi bi-upload me-1"></i>Upload
                        </a>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <!-- Required Documents for this Phase -->
                        <h6 class="small text-muted mb-3">Required Documents:</h6>
                        {% for doc_def in phases[phase_num]['documents'] %}
                        {% set uploaded_doc = documents_by_phase.get(phase_num, {}).get(doc_def['key']) %}
                        <div class="d-flex align-items-center gap-3 p-2 rounded mb-2" style="background: {% if uploaded_doc %}#d1fae5{% else %}#fef3c7{% endif %};">
                            <i class="bi {% if uploaded_doc %}bi-file-earmark-check text-success{% else %}bi-file-earmark-x text-warning{% endif %} fs-4"></i>
                            <div class="flex-grow-1">
                                <div class="fw-medium">{{ doc_def['name'] }}</div>
                                {% if uploaded_doc %}
                                <small class="text-muted">
                                    {{ uploaded_doc.original_filename }} · 
                                    <span class="badge bg-{{ 'success' if uploaded_doc.status == 'approved' else 'warning' if uploaded_doc.status == 'pending' else 'danger' }}">
                                        {{ uploaded_doc.status.title() }}
                                    </span>
                                </small>
                                {% else %}
                                <small class="text-warning">Not uploaded</small>
                                {% endif %}
                            </div>
                            {% if uploaded_doc %}
                            <a href="{{ url_for('download_document', document_id=uploaded_doc.id) }}" class="btn btn-sm btn-light">
                                <i class="bi bi-download"></i>
                            </a>
                            {% endif %}
                            <!-- Download Template if available -->
                            {% set template = templates_by_phase.get(phase_num, {}).get(doc_def['key']) %}
                            {% if template %}
                            <a href="{{ url_for('download_template', template_id=template.id) }}" class="btn btn-sm btn-outline-primary" title="Download Template">
                                <i class="bi bi-file-arrow-down"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Right: GEA Review & Actions -->
            <div class="col-lg-4">
                {% if phase_num == project.current_phase %}
                <!-- GEA Review Panel -->
                {% if current_user.is_gea() %}
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-shield-check me-2"></i>GEA Review
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('review_project', project_id=project.id) }}" method="POST">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Review Notes</label>
                                <textarea name="notes" class="form-control" rows="3" placeholder="Enter review comments...">{{ project.gea_notes or '' }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Decision</label>
                                <div class="d-grid gap-2">
                                    <button type="submit" name="action" value="approved" class="btn btn-success">
                                        <i class="bi bi-check-circle me-2"></i>Approve Phase
                                    </button>
                                    <button type="submit" name="action" value="changes_requested" class="btn btn-warning">
                                        <i class="bi bi-pencil me-2"></i>Request Changes
                                    </button>
                                    <button type="submit" name="action" value="rejected" class="btn btn-danger">
                                        <i class="bi bi-x-circle me-2"></i>Reject
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}
                
                <!-- Advance Phase Button (for GLAB) -->
                {% if not current_user.is_gea() and project.gea_status == 'approved' and project.current_phase < 8 %}
                <div class="card mb-4 border-success">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-right-circle fs-1 text-success d-block mb-2"></i>
                        <h6>Ready to Proceed</h6>
                        <p class="small text-muted">GEA has approved this phase. You can now advance to the next phase.</p>
                        <form action="{{ url_for('advance_phase', project_id=project.id) }}" method="POST">
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Advance to Phase {{ project.current_phase + 1 }}?')">
                                <i class="bi bi-arrow-right me-2"></i>Proceed to Phase {{ project.current_phase + 1 }}
                            </button>
                        </form>
                    </div>
                </div>
                {% elif not current_user.is_gea() and project.gea_status == 'pending' %}
                <div class="card mb-4 border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-hourglass-split fs-1 text-warning d-block mb-2"></i>
                        <h6>Awaiting GEA Review</h6>
                        <p class="small text-muted mb-0">Complete all checklist items and upload required documents. GEA will review before you can proceed.</p>
                    </div>
                </div>
                {% elif not current_user.is_gea() and project.gea_status == 'changes_requested' %}
                <div class="card mb-4 border-danger">
                    <div class="card-body text-center">
                        <i class="bi bi-exclamation-triangle fs-1 text-danger d-block mb-2"></i>
                        <h6>Changes Requested</h6>
                        <p class="small text-muted mb-0">GEA has requested changes. Please review comments and make corrections.</p>
                        {% if project.gea_notes %}
                        <hr>
                        <p class="small text-start"><strong>GEA Notes:</strong><br>{{ project.gea_notes }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- Phase Status -->
                <div class="card mb-4">
                    <div class="card-header">Phase {{ phase_num }} Status</div>
                    <div class="card-body">
                        {% if phase_num < project.current_phase %}
                        <div class="text-center text-success">
                            <i class="bi bi-check-circle-fill fs-1 d-block mb-2"></i>
                            <strong>Completed</strong>
                        </div>
                        {% elif phase_num == project.current_phase %}
                        <div class="text-center text-primary">
                            <i class="bi bi-play-circle-fill fs-1 d-block mb-2"></i>
                            <strong>In Progress</strong>
                        </div>
                        {% else %}
                        <div class="text-center text-muted">
                            <i class="bi bi-lock-fill fs-1 d-block mb-2"></i>
                            <strong>Locked</strong>
                            <p class="small mb-0">Complete previous phases first</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Project Info Sidebar -->
<div class="row mt-4">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">Project Information</div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="text-muted">GLAB</td>
                        <td class="text-end fw-medium">{{ project.glab.name }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Client</td>
                        <td class="text-end fw-medium">{{ project.client.name }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Type</td>
                        <td class="text-end">{{ project.assessment_type.replace('_', ' ').title() }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Created</td>
                        <td class="text-end">{{ project.created_at.strftime('%b %d, %Y') }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Lead Assessor</td>
                        <td class="text-end">{{ project.lead_assessor or '-' }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">Assigned Assessors</div>
            <div class="card-body">
                {% if project.assessors %}
                {% for assessor in project.assessors %}
                <div class="d-flex align-items-center gap-2 mb-2">
                    <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.8rem;">{{ assessor.username[0].upper() }}</div>
                    <div>
                        <div class="small fw-medium">{{ assessor.full_name or assessor.username }}</div>
                        <div class="small text-muted">{{ assessor.email }}</div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted small mb-0">No assessors assigned yet.</p>
                {% endif %}
                {% if current_user.role == 'glab_admin' %}
                <button class="btn btn-sm btn-gea-outline mt-2" data-bs-toggle="modal" data-bs-target="#manageAssessorsModal">
                    <i class="bi bi-person-plus me-1"></i>Manage Assessors
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">Financial Summary</div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="text-muted">Total Fee</td>
                        <td class="text-end fw-medium">${{ "{:,.2f}".format(project.total_fee or 0) }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Paid</td>
                        <td class="text-end text-success">${{ "{:,.2f}".format(project.amount_paid or 0) }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">GEA Fee (10%)</td>
                        <td class="text-end">${{ "{:,.2f}".format(project.gea_fee or 0) }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">GEA Remitted</td>
                        <td class="text-end">
                            {% if project.gea_fee_remitted %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function toggleChecklist(projectId, itemId, element) {
    fetch(`/api/projects/${projectId}/checklist/${itemId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to update checklist');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update checklist');
    });
}

function assignAssessor(assessorId) {
    fetch(`/projects/{{ project.id }}/assessors/assign`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({assessor_id: assessorId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to assign assessor');
        }
    });
}

function removeAssessor(assessorId) {
    if (!confirm('Remove this assessor from the project?')) return;
    fetch(`/projects/{{ project.id }}/assessors/remove`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({assessor_id: assessorId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to remove assessor');
        }
    });
}
</script>

<!-- Manage Assessors Modal -->
{% if current_user.role == 'glab_admin' %}
<div class="modal fade" id="manageAssessorsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-people me-2"></i>Manage Project Assessors</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="text-muted mb-3">Currently Assigned</h6>
                {% if project.assessors %}
                <div class="list-group mb-4">
                    {% for assessor in project.assessors %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ assessor.full_name or assessor.username }}</strong>
                            <br><small class="text-muted">{{ assessor.email }}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeAssessor({{ assessor.id }})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-4">No assessors assigned yet.</p>
                {% endif %}
                
                <h6 class="text-muted mb-3">Available Assessors</h6>
                <div class="list-group">
                    {% for assessor in available_assessors %}
                    {% if assessor not in project.assessors %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ assessor.full_name or assessor.username }}</strong>
                            <br><small class="text-muted">{{ assessor.email }}</small>
                        </div>
                        <button class="btn btn-sm btn-gea-outline" onclick="assignAssessor({{ assessor.id }})">
                            <i class="bi bi-plus"></i> Assign
                        </button>
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="text-muted">No available assessors. Contact GEA to assign assessors to your GLAB.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
